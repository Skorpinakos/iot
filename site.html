<!DOCTYPE html>
<html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=UTF-8"><!--API key== AIzaSyA8UuMACOY60siOk58pGAyDzmyjhzIOGYk -->
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Assistant&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Istok+Web&display=swap">
  <script>
    // Callback function to handle the Google Maps API loading
    function initMap() {
        // Your map initialization code here
        var map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: -34.397, lng: 150.644},
            zoom: 8
        });
    }
</script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <link rel="stylesheet" type="text/css" href="styles.css">
      
  <title>Bus Stop Monitoring</title>
  </head>
  <body>
      <header>
          <h3 id="site-name">Bus Stop Monitoring</h3>
          <div class="buttons-and-tabs">
              <div class="buttons">
                  <button class="button">Sign in</button>
                  <button class="button">subscription</button>
              </div>
          
              <div class="tab-menu">
                  <a href="#" class="tab">Home</a>
                  <a href="#" class="tab">About</a>
                  <a href="#" class="tab">Contact</a>
                  <a href="#" class="tab">Monitoring</a>
              </div>
          </div>
      </header>
          <div class="center-container">
              <div class="map-container">
                  <iframe
                      id="mapFrame"
                      width="500"
                      height="300"
                      frameborder="0"
                      scrolling="no"
                      marginheight="0"
                      marginwidth="0"
                      src="https://maps.google.com/maps?q=Patras&amp;output=embed"
                  ></iframe>
              </div>
              <div class="dropdown">
                  <h5>Find the bus information you need</h3>
                  <div class="search-input-dropdown">
                      <input type="text" id="searchInput" placeholder="Search...">
                  
                  <div class="dropdown-content">
                      <a id="1" href="#" data-value="38.280435015240556,21.768746092828305">601 Πανεπιστήμιο - Νοσοκομείο</a>
                      <a id="2" href="#" data-value="38.280435015240778,21.768746095218305">604 Πανεπιστήμιο - Νοσοκομείο - Ρίο</a>
                      <a id="3" href="#" data-value="38.280435015240556,21.768746092828527">605 Πανεπιστήμιο - Νοσοκομείο - Άγ. Βασίλειος - Ρίο</a>
                      <a id="4" href="#" data-value="38.280435015240556,21.768746092828414">609 Κέντρο</a>
                  </div>
                  <input type="text" placeholder="Specify time (optional)">
                  </div>
                  <div id="location_checkbox">
                    <input type="checkbox" class="l1" id="location" onclick="getUserLocation()" name="Read location" value="no">
                    <label for="location" class="l1"> Read location</label><br>
                  </div>
              </div>

        </div>
  </body>
  <script>
    const apiKey = 'AIzaSyA8UuMACOY60siOk58pGAyDzmyjhzIOGYk';
    destination = '38.280435015240556,21.768746092828305';
document.addEventListener('DOMContentLoaded', function () {
    // Add event listener for clicks on the window
    window.addEventListener('click', handleWindowClick);

    // Add event listener for input in the search box
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', handleSearchInput);
});

// Function to handle clicks on the window
function handleWindowClick(event) {
    const dropdownContent = event.target.closest('.dropdown-content');
    
    if (dropdownContent) {
        getLocationAndUpdateDataValue(event.target);
        updateMapFrame(event.target);
    }
}

// Function to handle input in the search box
function handleSearchInput() {
    const searchInput = document.getElementById('searchInput');
    const filter = searchInput.value.toLowerCase();
    const dropdownItems = document.querySelectorAll('.dropdown-content a');

    dropdownItems.forEach(function (item) {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(filter) ? 'block' : 'none';
    });
}

// Function to get location and update data-value
async function getLocationAndUpdateDataValue(clickedElement) {
    try {
        const response = await fetch('http://localhost:3000/getlocation');
        const data = await response.json();

        // Update the data-value attribute for the clicked element
        clickedElement.setAttribute('data-value', data.location);
        console.log('Location updated:', data.location);
        destination=data.location;
    } catch (error) {
        console.error('Error fetching location:', error.message);
    }
}
async function gettime_directions(origin) {
    try {
        const response = await fetch('http://localhost:3000/googlemaps');
        const dt = await response.json();
        fetch(`http://localhost:3000/googlemaps?origin=${origin}&destination=${destination}&key=AIzaSyA8UuMACOY60siOk58pGAyDzmyjhzIOGYk`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
            })
            .catch(error => console.error('Error:', error));
        console.log(`http://localhost:3000/googlemaps?origin=${origin}&destination=${destination}&key=${apiKey}`)
    } catch (error) {
        console.error('Error fetching location:', error.message);
    }
    
}

// Function to update the map frame based on the clicked element
function updateMapFrame(clickedElement) {
    const selectedLocation = clickedElement.getAttribute('data-value');
    const mapUrl = `https://www.google.com/maps/embed/v1/place?q=${selectedLocation}&key=${apiKey}`;
    document.getElementById("mapFrame").src = mapUrl;
}

// Function to get the user's location
function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}

function showPosition(position) {
    var latitude = position.coords.latitude;
    var longitude = position.coords.longitude;
    origin= `${latitude},${longitude}`;
    console.log("origin ",origin)
    console.log("destination ",destination)
    gettime_directions(origin);
    alert("Your location is: " + latitude + ", " + longitude);
}

function showError(error) {
    switch (error.code) {
        case error.PERMISSION_DENIED:
            alert("User denied the request for Geolocation.");
            break;
        case error.POSITION_UNAVAILABLE:
            alert("Location information is unavailable.");
            break;
        case error.TIMEOUT:
            alert("The request to get user location timed out.");
            break;
        case error.UNKNOWN_ERROR:
            alert("An unknown error occurred.");
            break;
    }
}
    
  </script>
 <!--  <script>
    const origin = "37.933895028607246,21.145880687363487";
    const destination = '38.31780641189159,21.816399632212832';
    const apiUrl = 'http://localhost:3000/googlemaps';
    const encodedOrigin = encodeURIComponent(origin);
    const encodedDestination = encodeURIComponent(destination);
    const encodedApiKey = encodeURIComponent(apiKey);

    fetch(`${apiUrl}?origin=${origin}&destination=${destination}&key=AIzaSyA8UuMACOY60siOk58pGAyDzmyjhzIOGYk`)/* , {mode:"no-cors"} */
        .then(response => response.json())
        .then(data => {
            console.log(data);
        })
        .catch(error => console.error('Error:', error));
    console.log(`${apiUrl}?origin=${origin}&destination=${destination}&key=${apiKey}`)  </script> -->
  <!-- <script src="mapsjs.js"></script>
  <script src="mapsjs2.js"></script> -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8UuMACOY60siOk58pGAyDzmyjhzIOGYk&callback=initMap&libraries=places,geometry&solution_channel=GMP_QB_commutes_v2_c" async defer></script>
  </html>
